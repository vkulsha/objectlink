<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta http-equiv="Cache-Control" content="no-cache" />
		
		<link rel="shortcut icon" href="/images/logo.png" type="image/png">

		<link rel="stylesheet" href="modules/leaflet/leaflet_1.2.0.css" />
		<link rel="stylesheet" type="text/css" href="main.css?@">

	<!--<script src="modules/jquery/jquery-3.2.1.min.js"></script>-->
		<script src="modules/leaflet/leaflet_1.2.0.js"></script>
		<script src="modules/leafletEditable/Leaflet.Editable.js"></script>
		<script src="modules/md5/md5.js"></script>
		<script src="service.js?@"></script>
		<script src="map.js?@"></script>
	</head>
	<body>
		<div id="map" style="position:absolute; width:100%; height:100%"></div>
		<div style='position:absolute; left:0px; top:0px; width:100%; height:100%; z-index:1100000; background-color:rgba(0,0,0,0.5); background-image:url(images/logo.png); background-repeat: no-repeat; background-size:30%; background-position: center center' id='pLoginMain'>
			<br><br><br>
			<h1 align="middle" style="text-align:center; color:#fff">–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê</h1>
			
			<div id='pLogin' style='background-color:rgba(0,0,0,0.5);' class="centered">
				<form name="fLogin" onsubmit='return false;' id='fLogin'>
				<table cellpadding="5" cellspacing="5">
					<tr><td>–õ–æ–≥–∏–Ω:</td><td> <input type='text' style='opacity:0.8; border:1px solid #000' id='eUser' autofocus></td></tr>
					<tr><td>–ü–∞—Ä–æ–ª—å:</td><td> <input type='password' style='opacity:0.8;  border:1px solid #000' id='ePassword' name='ePassword'></td></tr>
					<tr><td colspan=2 align='center'><button id='bLogin'>–í–æ–π—Ç–∏</button></td></tr>
				</table>
				</form>
			</div>
		</div>
	
<script lang="javascript">
var classes_;
var classes;
var classes2 = [];
var classes3 = function(cid){ return findObjVal(classes,cid)};
var classesGroup = [];
var fs = 11;
var frmPaintLayers = new Form(!"isModal");

var mapProps = orm("getMapProps",["map"]);
var map = L.map('map', {editable: true});
L.tileLayer(mapProps.tileLayer, mapProps.tileLayerParams).addTo(map);
map.setView(mapProps.setViewLatLng, mapProps.setViewZoom);
map.editTools.on('editable:drawing:end editable:vertex:contextmenu',function(e){ if (isPaintMode) endPaint(e.layer); })
var isPaintMode = false;
var currentEditing;
var currentEditingType;

var storageObjectsLS = (window.localStorage && window.localStorage.storageObjects) ? window.localStorage.storageObjects : "[]";
var storageObjects = JSON.parse(storageObjectsLS);
var selectedObjects = [];
var objectStorageFields = ["id", "n", "cid", "pid", "isClass"];
var specialLinkedClasses;
var frmObject = new Form(false);;
var storageMapLayers = [];
var isMapLinkEnabled = (window.localStorage && window.localStorage.isMapLinkEnabled) ? true : false;
var setViewObject;
var classesObjects = new ClassesObject();
var classesChains;

var globalstopFunction = false;

gDom("bLogin").onclick = function(){
	var auth = false;
	var eUser = document.fLogin.eUser.value;;
	var password = document.fLogin.ePassword.value;

	var openview = function() {
		console.time("initialization...");
		classes_ = orm("gAnd",[[1],"n,id",false,"",false,true]);
		classes = hash4arr(classes_);
		for (var i=0; i < classes_.length; i++) classes2.push(parseInt(classes_[i][1]));
		var arr = orm("gAnd",[[1,orm("gO",["–ì—Ä—É–ø–ø–∞ –∫–ª–∞—Å—Å–æ–≤",true])],"id"]);
		for (var i=0; i < arr.length; i++) classesGroup.push(parseInt(arr[i][0]));
		refreshClassesObjects();
		gDom("pLoginMain").hidden = true;
		initializeMapLinkForm(map, frmPaintLayers);
		frmPaintLayers.setCaption(cDom("LABEL","–°–ª–æ–∏ –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –∫ –∫–∞—Ä—Ç–µ:")).style.color = "#ffdd00";
		mapInit(map);
		frmMainSetVisibleTrue();
		console.timeEnd("initialization...");
		console.log("classes count: "+classes_.length);
	}
	
	var getLDAP = function() {
		var callback = function(resp) {
			var resp = JSON.parse(resp.data);
			if (resp) {
				openview();
			} else {
			}
		}
		getXmlHttpReq(callback, "php/ldap.php?p1="+eUser+"&p2="+password+"&p3=guss.ru", null, true);
	}
	
	var auth = orm("gLogin",[eUser, md5(password)]);
	if (auth && auth.uid) {
		currentUser = auth;
		if (auth.auth) {
			openview();
		} else {
			getLDAP();
		}
	}

}

function getPolicy(oid){ return orm("getPolicy",["cL",oid]); }

function refreshClassesObjects(){
	var cls = orm("getClassesWithParent",[]);

	for (var i=0; i < classes2.length; i++){
		var cid = classes2[i];
		var cObject = new ClassObject(cid);
		classesObjects.addClass(cObject);
	}
	for (var i=0; i < cls.length; i++){
		var c = cls[i];
		var c1 = classesObjects.getClass(+c[0]);
		var c2 = classesObjects.getClass(+c[1]);
		if (c1 && c2) {
			c1.setParent(c2);
			c2.setChild(c1);
		}
	}
	
	return classesObjects;
}

//////////////
function frmMainSetVisibleTrue(){
	loadNewForm(currentUser.oid, currentUser.cid);
}

function loadNewForm(id, cid){
	specialLinkedClasses = getSpecLinkedClasses()
	var frm = frmObject;
	frm.getBody().innerHTML = "";
	frm.getCaption().innerHTML = "";
	frm.setVisible(true);
	frm.setWidth("450px");
	initializeMainForm(frm);
	
	var n = orm("gN",[id]);
	var isClass = false;
	var rootObject = {"id":id, "cid":cid, "pid":0, "n":n, "isClass":isClass};
	rootObject.cnt = frm.getBody();

	if (window.localStorage && storageObjects.length && storageObjects[0].id != rootObject.id) {
		storageObjects = [];
		window.localStorage.storageObjects = "";
	}
	var _rootObject = objectLoad(rootObject, false, true);

	if (!storageObjects.length) {
		_rootObject.but.dispatchEvent(new Event("click"));
	} else {
		runStorageObjects();
	}

}

function runStorageObjects(){
	var _storageObjects = storageObjects.slice();
	for (var i=0; i < _storageObjects.length; i++){
		var object = _storageObjects[i];
		var but = gDom("but.object.id"+object.id+"pid"+object.pid);
		var event = new Event("click");
		event.isNotCalsCount = (i == _storageObjects.length-1 ? false : true);
		if (but) but.dispatchEvent(event);
	}
}

function getSpecLinkedClasses(){
	return {map: getMapLinkedClasses()};
}

function getMapLinkedClasses(){
	return getLinkedClasses(classes["–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ"]).concat(
		getLinkedClasses(classes["–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–µ"])
	)
}

function getLinkedClasses(id){
	var arr = orm("gAnd",[[id],"id,n",false,"",true,true]);
	var ret = [];
	for (var i=0; i < arr.length; i++){
		ret.push(+arr[i][0]);
	}
	return ret;
}

function getAllObjectsFromClassLinkedObject(object, cid){
	if (!object.isClass){
		var pcid = object.id;
		
	}
}

function getClassChain(cid){
	var ret = [cid];
	var arr = orm("gAnd",[[cid],"id",false,"and id <> 1",false,true]);
	for (var i=0; i < arr.length; i++){
		var _cid = +arr[i][0];
		if (_cid == +cid) continue;
		ret.push(getClassChain(_cid));
	}
	//console.log(cid)
	return ret;
}
///////

function initializeMainForm(frm){
	var cap = frm.getCaption();
	var tb = cDom("table","",cap);
		var tr =  cDom("tr","",tb);
			var td =  cDom("td","",tr);
				var eFilter =  cInp("edit","",td);
				eFilter.classList.add("eobject");
				eFilter.placeholder = "–ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö";
				eFilter.style.width = "135px";
			var td =  cDom("td","",tr);
				var bAdd =  cDom("button","",td);
				bAdd.innerHTML = "+";
				bAdd.classList.add("eobject");
				bAdd.title = "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Ç–µ–∫—â–∏–π —ç–ª–µ–º–µ–Ω—Ç";
			var td =  cDom("td","",tr);
				var bUpd =  cDom("button","",td);
				bUpd.innerHTML = "‚úé";
				bUpd.style.fontFamily = "Windings 2";
				bUpd.classList.add("eobject");
				bUpd.title = "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞";
			var td =  cDom("td","",tr);
				var bDel =  cDom("button","",td);
				bDel.innerHTML = "-";
				bDel.classList.add("eobject");
				bDel.title = "–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤";
			var td =  cDom("td","",tr);
				var bTable =  cDom("button","",td);
				bTable.innerHTML = "#";
				bTable.classList.add("eobject");
				bTable.title = "–¢–∞–±–ª–∏—Ü–∞";
			var td =  cDom("td","",tr);
				var bMap =  cDom("button","",td);
				bMap.innerHTML = "üñà";
				bMap.classList.add("eobject");
				bMap.title = "–í–∫–ª –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ";
			var td =  cDom("td","",tr);
				var bFiles =  cDom("button","",td);
				bFiles.innerHTML = "‚ùè";
				bFiles.classList.add("eobject");
				bFiles.title = "–Ω–∞–π—Ç–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–π –∑–∞–ø–∏—Å–∏";
			var td =  cDom("td","",tr);
				var bSetup =  cDom("button","",td);
				bSetup.innerHTML = "üõ†";
				bSetup.classList.add("eobject");
				bSetup.title = "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
	
	bSetup.onclick = function(){
		userSetup();
	}
	
	bFiles.onmousedown = function(e){
		objectsGetFiles(e);
	}
	
	bAdd.onclick = function(){
		objectAdd(null, this);
	}
	
	bUpd.onclick = function(){
		objectUpd();
	}
	
	bDel.onclick = function(){
		if (selectedObjects.length) {
			objectsDel();
		} else {
			objectDel(null,true);
		}
	}
	
	bTable.onclick = function(){
		objectsTable()
	}
	
	bMap.checked = !!isMapLinkEnabled;
	if (bMap.checked) bMap.style.backgroundColor = "rgba(255,0,0,0.3)";
	bMap.onclick = function(){
		this.checked = !this.checked;
		isMapLinkEnabled = this.checked;
		window.localStorage.isMapLinkEnabled = isMapLinkEnabled ? "1" : "";
		bMap.title = (this.checked ? "–í—ã–∫–ª" : "–í–∫–ª")+" –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ";
		
		if (this.checked) {
			this.style.backgroundColor = "rgba(255,0,0,0.3)";
			runStorageObjects();
		} else {
			this.style.backgroundColor = "rgba(0,0,0,0.3)";
			clearStorageMapLayers();
		}
		refreshMapLinkForm(frmPaintLayers);
	}
}

function userSetup(){
	loadNewForm(currentUser.uid, classes["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"]);
}

function objectsGetFiles(e){
	new ContextMenu([
		new ContextMenuItem("–§–∞–π–ª—ã", function(){ getSpecObjectFromStorageObjects(+classes["–§–∞–π–ª—ã"]);	}, this), 
		new ContextMenuItem("–§–æ—Ç–æ", function(){ 
			getSpecObjectFromStorageObjects(+classes["–§–æ—Ç–æ"], function(data){
				var frm = data;
				var objects = frm.objects;
				var images = [];
				for (var i=0; i < objects.length; i++){
					images.push(objects[i].n);
				}
				imagesPhotoGallery(images, frm.getCaption().innerHTML);
				
				var but = frm.getCaption().appendChild(cDom("button","–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ–±—É–∫–ª–µ—Ç"));
				but.images = images;
				but.style.height = "30px";
				but.onclick = function(){
					var data = {"caption":"–≥. –ú–æ—Å–∫–≤–∞, –ö–∏—Ä–ø–∏—á–Ω—ã–π –ø–µ—Ä., 17", "data":[{"caption":"–§–æ—Ç–æ –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–∂–∞", "images":images}]};
					openWindow(domain+"php/booklet.php?data="+JSON.stringify(data));
				}
			});	
		}, this), 
	], e.pageX, e.pageY);
}

function objectAdd(object, bAdd){
	object = object || (storageObjects.length ? storageObjects.slice(-1)[0] : null);
	if (!object) return;

	var lid = (!object.isClass || object.isGroup) ? ( object.isGroup ? object.id : object.cid ) : ( object.pobject.isGroup ? object.pobject.pid : object.pobject.id) ;
	if (!object.isClass || object.isGroup) {
		if (getPolicy(1)) {
			var oid = object.id;
			ObjectSelectForm(object, {caption: "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –≤ –∫–ª–∞—Å—Å '"+orm("gN",[lid])+"':",defval:"",callback:function(n, object){
				var newoid = n ? orm("cO",[n, classes["–ö–ª–∞—Å—Å"]]) : 0;
				var newlink = newoid && lid ? orm("cL",[newoid, lid]) : 0;
				if (classes2.indexOf(newoid)==-1) classes2.push(+newoid);
				object.but.click(true);
			}});
		} else { alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞!"); }
	} else {
		var cid = object.id;
		var classname = classes3(cid);
		
		if (getPolicy(cid) || getPolicy(lid)) {
			if (object.isFile){
				objectUploadFile(object); 
			} else if (object.isMap) {
				objectMapAdd(object, bAdd);
			} else {
				var objname = orm("gN",[lid]);
				var n = classname+(objname ? " "+objname + " " + Date.now() : "");// + " " + Date.now();
				var newoid = n ? orm("cO",[n, cid]) : 0;
				var newlink = newoid && lid ? orm("cL",[newoid, lid]) : 0;
				if (newoid){
					object.but.click(true);
					var but = gDom("but.object.id"+newoid+"pid"+object.pid);
					if (but) {
						but.focus();
						objectEdit(but.object, function(val, _object){
							orm("uO", [_object.id, val, _object.pid]);
							_object.pobject.but.click(true);
							var but = gDom("but.object.id"+_object.id+"pid"+_object.pid);
							if (but) but.click(true);
						})
					}
				}
				
			}
		} else { alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Å '"+classname+"'!") };
	}
}

function objectMapAdd(object, bAdd){
	function startPaint(funcPaint){
		L.DomEvent.stop;
		var func = map.editTools["start"+funcPaint];
		isPaintMode = true;
		currentEditingType = funcPaint;
		window.LAYER = func.call(map.editTools);
	}

	var layer;
	var cidMapLink = object.id;
	var cidMapLinkFunc = +classes["–§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"];
	var cidMapLinkFuncParams = +classes["–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"];
	var res = orm("gT",[[object.pcid,cidMapLink,cidMapLinkFunc,cidMapLinkFuncParams],[0,1,2,2],"and id"+cidMapLink+" is not null and id"+cidMapLinkFunc+" is not null limit 1"]);
	if (res && res.length){
		var layer = res[0];
		var funcPaint = layer[5];
		var funcPaintParams = layer[7];
		console.log(funcPaint, funcPaintParams);
		startPaint(funcPaint);
		
	} else {
		var x = bAdd.getBoundingClientRect().left;
		var y = bAdd.getBoundingClientRect().top;
		new ContextMenu([
			new ContextMenuItem("Marker", function(){ startPaint("Marker"); }, this), 
			new ContextMenuItem("Polyline", function(){ startPaint("Polyline"); }, this), 
			new ContextMenuItem("Polygon", function(){ startPaint("Polygon"); }, this), 
			new ContextMenuItem("Circle", function(){ startPaint("Circle"); }, this), 
		], x, y);
	}
}

function objectEdit(object, callback){
	var _but = object.but;
	if (!_but) return;
	var but = cDom("button");
	but.style.width = "100%";
	_but.parentElement.appendChild(but);
	_but.remove();
	but.innerHTML = ""
	but.onclick = function(){ return false};
	var defval = object.n;
	but.innerHTML = "";
	var objects = gAndObject(object.pobject, true);
	var objectlist = ObjectListDom(objects);
	var list = objectlist.list;
	list.style.width = "300px";
	list.classList.add("eobject");
	var datalist = objectlist.datalist;
	but.appendChild(list);
	but.appendChild(datalist);
	list.value = defval;
	list.focus();
	list.onkeydown = func;
	list.onblur = func;

	function func(e){
		if (e.keyCode == 27) {
			object.pobject.but.click(true);
		} else if (!e.keyCode || e.keyCode == 13) {
			callback(this.value, object)
		}
	}
	
}

function objectUpd(object){
	object = object || (storageObjects.length ? storageObjects.slice(-1)[0] : null);
	if (!object) return;
	var _n = object.n;

	var cid = object.isClass ? 1 : object.cid;
	if (getPolicy(cid)) {
		objectEdit(object, function(val, _object){
			var object = _object;
			var pobject = object.pobject;
			var oid_ = pobject.id;
			var cid_ = pobject.cid;
			var o1 = object.id;
			var o2 = object.isClass ? object.pcid : object.pid;
			var cid = object.isClass ? 1 : object.cid;
			var _n = object.n;
			var n = val;
			
			if ( n && n != _n ){
				var newoid = orm("mO",[n, cid, o1]);
				if (newoid) {
					orm("cL",[newoid, o2]);
					orm("nL",[o1, o2]);
				}
				console.log(n, cid, o1, o2);
				if (pobject) pobject.but.click(true);
			}
		})
	} else { alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ '"+_n+"'!") };


}

function objectDel(object, refreshPObject){
	object = object || (storageObjects.length ? storageObjects.slice(-1)[0] : null);
	if (!object) return;
	
	var pobject = object.pobject;
	var o1 = object.id;
	var lid = !object.isClass ? object.pid : ( pobject.isGroup ? pobject.id : pobject.cid );
	var n_ = orm("gN",[o1]);

	if (getPolicy(o1)) {
		if ( confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å '"+n_+"' –∏–∑ '"+orm("gN",[lid])+"'?") ){
			var res = orm("nL",[o1, lid]);
			if (res) { 
				if ((object.isMap || object.isMapLinked) && object.layers && object.layers.length) { object.layers.forEach( function(layer){ layer.remove(); } ) };
				if (pobject && refreshPObject) pobject.but.click(true);
			};
		}
	} else { alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ '"+n_+"'!") };


}

function objectsDel(objects){
	objects = objects || selectedObjects;
	if (!objects || !objects.length) return;
	
	var pobject = objects[0].pobject; 

	for (var i=0; i < objects.length; i++) {
		var object = objects[i];
		objectDel(object);
	}

	if (pobject) pobject.but.click(true);

}

function objectUploadFile(object){
	var cids = [object.id] || [classes["–§–∞–π–ª—ã"]];
	var domSelFiles = cInp("FILE");
	domSelFiles.multiple = true;
	var bSend = cDom("BUTTON","–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã");
	bSend.domSelFiles = domSelFiles;
	bSend.object = object;
	bSend.onclick = function(){
		var oid = this.object.pobject.id;
		var files = this.domSelFiles.files;
		var count = 0;
		for (var i=0; i < files.length; i++) {
			var formData = {"MAX_FILE_SIZE": 0, "uploadPath": "../data/"+oid+"/", "uploadId": oid, "uploadCids": JSON.stringify([cids]), "userfile[]": this.domSelFiles.files[i], "u": currentUser.uid};
			getXmlHttpReq(function(result){
				if (result.data && result.data.length) count++;
				console.log("fileupload",result);
			}, "php/uploadFiles.php", formData, false)
		};
		if (count < files.length) alert ("–ë—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–µ –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã!");
		object.but.click(true);
	}
	domSelFiles.click();
	domSelFiles.onchange = function(){
		bSend.onclick();
	}
}

////////////////////
function objectsTable(_classes, _links, _hidden, _cond){
//	var _object = storageObjects[0];
//	cid = (_object.isClass ? _object.id : _object.cid);
	_links = _links || [];
	_hidden = _hidden || [];
	var cond = _cond || "";

	if (!_classes) {
		var _object = storageObjects[storageObjects.length-1];
		var _pobject = _object;
		var cn = "";
		
		if (_object.isClass) {
			cn = _object.isGroup ? "" : classes3(_object.isClass ? _object.id : _object.cid);
			_pobject = storageObjectsGet(_object.pid);
		}
		_classes = [classes3(_pobject.cid)];
		if (cn) _classes.push(cn);
		cond = " and `id_"+classes3(_pobject.cid)+"` = "+_pobject.id;
		
		/*if (!_object.isClass) {
			objects = gAndObject(_object);
			for (var i=0; i < objects.length; i++){
				if (classesGroup.indexOf(+objects[i][0])>=0) continue;
				_classes.push(objects[i][1]);
				if (ind) _links.push([_classes.length-1, _classes.length-2]);
			}
		}*/
	}

//	_classes = _classes || [classes3(cid)];
	
	var rows = orm("gT2",[_classes,_links,[],false,null,cond]);
	var tb = cDom("table");
	var tbstr = ["<table>"];
	tb.setAttribute("border",1);
	var frm = new Form(true);
	frm.setVisible(true);
	frm.getBody().appendChild(tb);
	frm.classes = _classes;
	frm.links = _links;
	frm.tb = tb;
	frm.hiddenclasses = _hidden;
	frm.cond = cond;
	
	var tr = cDom("tr","",tb);
	var td = cDom("td","",tr);
	td.setAttribute("colspan",_classes.length);
	var bExcel = cDom("button");
	var img = cDom("img");
	bExcel.appendChild(img)
	img.src = "images/excel.png";
	img.style.width = "32px";
	bExcel.tbstr = tbstr;
	td.appendChild(bExcel).onclick = function(){
		tableToExcel(this.tbstr.join(""), "–û—Ç—á–µ—Ç"+Date.now())
	}
	td.style.textAlign = "left";

	var tr = cDom("tr","",tb);
	tbstr.push("<tr>");
	for (var i=0; i < _classes.length; i++){
		if (frm.hiddenclasses.indexOf(i) >=0) continue;
		var td = cDom("td","",tr);
		var id = classes[_classes[i]]
		var cid = id;
		var n = _classes[i];
		var pid = i>0 ? classes[_classes[i-1]] : 0;
		var object = new ObjectButton({id:id,n:n,cid:cid,isClass:true,pid:pid});
		object.ind = i;
		var bAdd = new ButTableClassAdd(object);
		var bDel = new ButTableClassDel(object);
		bAdd.frm = frm;
		bDel.frm = frm;
		td.appendChild(bDel.div);
		td.appendChild(bAdd.div);
		td.appendChild(object.but);
		td.style.textAlign = "right"
		td.ind = i;
		td.cid = cid;
		tbstr.push("<th>"+n+"</th>");
	}
	tbstr.push("</tr>");

	for (var i=0; i < rows.length; i++){
		var tr = cDom("tr","",tb);
		tbstr.push("<tr>");
		var row = rows[i];
		for (var j=0; j < row.length/2; j++){
			if (frm.hiddenclasses.indexOf(j) >=0) continue;
			var cid = classes[_classes[j]];
			var ind = j*2;
			var td = cDom("td","",tr);
			var id = row[ind+0];
			var n = row[ind+1];
			var pid = j>0 ? row[(j-1)*2] : 0;
			td.appendChild(new ObjectButton({id:id,n:n,cid:cid,isClass:false,pid:pid}).but);
			td.ind = j;
			td.cid = cid;
			tbstr.push("<td>"+n+"</td>");
		}
		tbstr.push("</tr>");
	}
	tbstr.push("</table>");
}

function tableToExcel(html, filename) {
	let uri = 'data:application/vnd.ms-excel,'+encodeURIComponent( html );
	var link = document.createElement('a');
	link.download = filename;
	link.href = uri;
	link.click();
}

function ObjectButton(params){
	this.id = params.id;
	this.n = params.n;
	this.cid = params.cid;
	this.pid = params.pid;
	this.isClass = params.isClass || false;
	this.but = cDom("button");
	this.but.innerHTML = this.n;
	this.but.style.width = "100%";
	this.but.style.textAlign = this.isClass ? "center" : "left";
	this.but.style.fontWeight = this.isClass ? "bold" : "normal";
	this.but.object = this;
	this.but.onclick = function(){
		console.log(this.object);
	}
	this.cobject = classesObjects.getClass(this.cid)
}

function ButTableClassAdd(object){
	var that = this;
	this.but = cDom("button");
	this.object = object;
	this.ind = object.ind;
	this.but.innerHTML = "+";
	this.but.title = "–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å";
	this.but.object = this.object;

	this.selectcallback = function(value, cObject){
		if (cObject && cObject.isClassGroup) {
			alert("–í—ã –≤—ã–±—Ä–∞–ª–∏ –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Å–æ–≤, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã!")
			cObjectChildSelectOptions(cObject, that.selectcallback, that.select);
		} else {
			var _classes = that.frm.classes;
			var _links = that.frm.links;
			
			if (_classes.indexOf(value) >= 0) {
				var cells = that.frm.tb.getElementsByTagName("td");
				for (var i=0; i < cells.length; i++){ 
					if (cells[i].cid == classes[value] && cells[i].hidden) {
						cells[i].hidden = false;
						that.frm.hiddenclasses.splice(i,1);
					} 
				}
			} else {
				_classes.push(value);
				_links.push([_classes.length-1, that.ind]);
				that.frm.setVisible(false);
				objectsTable(_classes, _links, that.frm.hiddenclasses, that.frm.cond);
			}
		}
	}
	this.select = cObjectChildSelectOptions(this.object.cobject, this.selectcallback);
	
	this.div = cDom("DIV");
	this.div.appendChild(this.but);
	this.but.div = this.div;
	this.but.select = this.select;
	
	this.but.onclick = function(){
		this.div.appendChild(this.select);
	}
}

function ButTableClassDel(object){
	var that = this;
	this.but = cDom("button");
	this.object = object;
	this.ind = object.ind;
	this.but.innerHTML = "&times;";
	this.but.title = "–£–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å";
	this.but.object = this.object;

	this.div = cDom("DIV");
	this.div.appendChild(this.but);
	this.but.div = this.div;
	
	this.but.onclick = function(){
		var _classes = that.frm.classes;
		var _links = that.frm.links;
		var cells = that.frm.tb.getElementsByTagName("td");
		if (that.frm.hiddenclasses.indexOf(that.ind) == -1) that.frm.hiddenclasses.push(that.ind);
		
		for (var i=0; i < cells.length; i++){ if (cells[i].ind == that.ind) cells[i].hidden = true; }
	}
}

function cObjectChildSelectOptions(cObject, callback, select){
	var child = cObject ? cObject.child : [];
	var selectDom = select || cDom("select");
	if (select) selectDom.innerHTML = "";
	var opt = cDom("option","–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞...",selectDom);
	for (var i=0; i < child.length; i++){
		var id = child[i].cid;
		var n = classes3(id);
		var opt = cDom("option",n,selectDom);
		opt.value = n;
	}
	selectDom.callback = callback;
	selectDom.cObjects = child;
	selectDom.onchange = function(){
		this.callback(this.value, this.cObjects[this.selectedIndex-1]);
	}
	return selectDom;
}
//////////////////////////

function objectLoad(params, isNotCalsCount, notPadding){
	var object = {};//new Object();
	var tb = cDom("table");
	tb.classList.add("tbobject");
		var tr = cDom("tr","",tb);
			var td = cDom("td","",tb);
				var tb2 = cDom("table","",td);
				tb2.classList.add(notPadding ? "tbobjectnotpadding" : "tbobject");
					var tr21 = cDom("tr","",tb2);
						var td21 = cDom("td","",tr21);
						var sel =  cInp("checkbox","",td21);
						sel.classList.add("checkbox-custom");
						var td22 = cDom("td","",tr21);
						var but = cDom("button","",td22);
						td22.style.width = "100%";
		var tr1 = cDom("tr","",tb);
			var td1 = cDom("td","",tr1);
		var tr2 = cDom("tr","",tb);
			var td2 = cDom("td","",tr2);

	td1.style.textAlign = "left";
	td2.style.textAlign = "left";
	tb.style.width = "100%";
	tb2.style.width = "100%";
	tr1.hidden = true;
	tr2.hidden = true;

	object.cnt = tb;
	object.but = but;
	object.sel = sel;
	object.tr1 = tr1;
	object.tr2 = tr2;
	object.td1 = td1;
	object.td2 = td2;
	object.n = params.n;
	object.id = params.id;
	object.cid = params.cid;
	object.pid = params.pid;
	object.pcid = params.pcid;
	object.isClass = params.isClass;
	object.isGroup = params.isGroup;
	object.pobject = params.pobject;
	object.childobjects = [];
	
	but.caption = object.isGroup ? "["+object.n+"...]" : object.n;
	but.innerHTML = but.caption;
	but.style.textAlign = "left";
	but.style.width = "100%";
	but.style.color = object.isClass ? ( object.isGroup ? "#dd9900" : "#ffdd00" ) : "fff";
	but.style.fontWeight = object.isClass ? "bold" : "none";
	but.style.fontSize = object.isClass ? 12+"px" : 11+"px"; 
	but.object = object;
	but.id = "but.object.id"+object.id+"pid"+object.pid;

	sel.object = object;
	sel.disabled = true;
	sel.checked = false;
	sel.setAttribute("tabindex","-1");
	if (object.isClass && !object.isGroup && !isNotCalsCount) {
		var objectsCount = gAndObject(object).length;//speed 152ms vs 470ms in 16st => 3/1-2/1
		but.innerHTML = but.caption + " ("+objectsCount+")";
	}
	
	params.cnt.appendChild(tb);
	ifObject(object);
	
	return object;
}

function gAndObject(object, notParentLink){
	var and = [object.isClass ? object.id : object.cid];
	if (object.isClass && !object.isGroup && object.pid && !notParentLink) and.push(object.pid);
	return orm("gAnd",[and, "id,n", object.isClass && !object.isGroup, "and id<>1 order by c desc, n ", false, !object.isClass]);
}

function getSpecObjectFromStorageObjects(cid, callback){
	cid = +cid || +classes["–§–∞–π–ª—ã"];
	frm = new Form(false);
	frm.setVisible(true);
	frm.setWidth("400px");
	frm.objects = [];
	var imgloading = frm.getBody().appendChild(cDom("img"));
	imgloading.src = "images/loading.gif";
	imgloading.id = "imgLoadingGetSpecObjectFromStorageObjects";
	
	cap = [];
	for (var i=0; i < storageObjects.length; i++){
		var object = storageObjects[i];
		if (!object.isClass) { cap.push(object.n); }
	}
					
	frm.getCaption().appendChild(cDom("label",classes3(cid)+": "+cap.join(", ")));
	
	if (!classesChains) classesChains = new ClassesChains(classesObjects.getClass(1383));
	classesChains.gAnd(cid, function(data, islast, params){
		var frm = params.frm;
		var cnt = frm.getBody();
		var tb = cDom("table","",cnt);
		for (var i=0; i < data.length; i++){
			var n = data[i][0];
			var but = cDom("button",n, cDom("tr","",cDom("tr","",tb)) );
			var object = {isFile:true, isClass:false, n:n, cid:cid, but:but};
			but.object = object;
			ifObjectIsFile(object);
			frm.objects.push(object);
		}
		if (islast) {
			alert("–ü–æ–∏—Å–∫ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
			gDom("imgLoadingGetSpecObjectFromStorageObjects").remove();
			callback(frm);
		}
	}, {frm:frm})

}

////////////ifObject
function ifObject(object){
	object.isStandart = true &&
		!ifObjectIsScript(object) &&
		!ifObjectIsLink(object) &&
		!ifObjectIsFile(object);
		
	ifObjectIsObject(object);
	ifObjectIsMap(object);
	ifObjectIsMapLinked(object);
}

function ifObjectIsObject(object){
	function onclick(e){
		var object = this.object;
		if (!object.isStandart) return;
		storageObjectsAdd(object);
		selectedObjects = [];
		if (window.localStorage) window.localStorage.storageObjects = JSON.stringify(storageObjects, objectStorageFields);
		object.td1.innerHTML = "";
		object.td2.innerHTML = "";
		var objects = gAndObject(object);
		var tb = object.td1.appendChild(cDom("table"));
		tb.style.width = "100%";
		tb.classList.add("tbobject");
		object.tr1.hidden = !objects.length;
		if (object.isClass && !object.isGroup) this.innerHTML = this.caption + " ("+objects.length+")";
		object.childobjects = [];
		for (var i=0; i < objects.length; i++){
			var o = objects[i];
			var tr = tb.appendChild(cDom("tr"));
			var td = tr.appendChild(cDom("td"));
			var isGroup = classesGroup.indexOf(+o[0]) >= 0;
			var params = {
				"id"		: +o[0], 
				"n"			: o[1], 
				"cid"		: +(!object.isClass || isGroup ? object.cid : object.id), 
				"pid"		: +(object.isClass ? object.pid : object.id), 
				"pcid"		: +(object.isClass ? object.id : object.cid), 
				"isClass"	: (classes2.indexOf(+o[0])>=0), 
				"isGroup"	: isGroup,
				"cnt"		: tb, 
				"pobject"	: object
			};
			var _object = objectLoad(params, e.isNotCalsCount);
			_object.pobject.childobjects.push(_object);
			_object.sel.disabled = false;
			_object.sel.checked = false;
			
			_object.sel.onchange = function(){
				var object = this.object;
				if (selectedObjects.length){
					for (var i=0; i < selectedObjects.length; i++){
						if ( selectedObjects[i].id == object.id ){
							selectedObjects.splice(i,1)
						}
						if (this.checked) selectedObjects.push(object);
					}
				} else {
					if (this.checked) selectedObjects.push(object);
				}
			}
			
		}
		if (object.pobject) {
			object.pobject.td2.appendChild(object.cnt);
			object.pobject.tr2.hidden = false;
			object.pobject.tr1.hidden = true;
		}
		
		object.sel.onchange = function(){
			var object = this.object;
			selectedObjects = [];
			var childobjects = object.childobjects;
			if (childobjects && childobjects.length){
				for (var j=0; j < childobjects.length; j++){
					var sel = childobjects[j].sel;
					sel.checked = this.checked;
					if (this.checked) selectedObjects.push(childobjects[j]);
				}
			}
		}

		if (object.pobject) {
			object.pobject.sel.disabled = true;
			object.pobject.sel.checked = false;
		}
		object.sel.disabled = false;
		object.sel.checked = false;
		this.focus();
		
		if (!e.isNotCalsCount) console.log("id:",object.id,",cid:",object.cid,",pid:",object.pid,",pcid:",object.pcid);
	}
	object.but.addEventListener("click", onclick);

	object.but.addEventListener("contextmenu", function(){
		var object = this.object;
		var isStandart = object.isStandart;
		object.isStandart = true;
		var event = new Event("click");
		object.but.dispatchEvent(event);
		object.isStandart = isStandart;
		return false;
	});
	
	object.but.onkeydown = function(e){
		if (e.key == "Insert") { if (e.target.nodeName != "INPUT") {objectAdd(this.object); return false}}
		if (e.key == "Delete") { if (e.target.nodeName != "INPUT") {objectDel(this.object, true); return false;} }
		if (e.key == "F2") { if (e.target.nodeName != "INPUT") {objectUpd(this.object); return false;} }

	};
	
	return onclick;
}

function storageObjectsAdd(_object){
	for (var i=0; i < storageObjects.length; i++){
		var object = storageObjects[i];
		if (_object.id == object.id) {
			storageObjects.splice(i);
			break;
		}
	}
	
	storageObjects.push(_object);
	return _object
}

function storageObjectsGet(id){
	for (var i=0; i < storageObjects.length; i++){
		var object = storageObjects[i];
		if (object.id == id) {
			return object;
		}
	}
}

function ifObjectIsScript(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isScript = (cid == classes["–°–∫—Ä–∏–ø—Ç—ã"]);
	
	if (object.isScript && !object.isClass){
		object.but.addEventListener("click",  function(e){
			var object = this.object;
			if (object.isStandart) return;
			var func = orm("gAnd",[[object.id, classes["–§—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞"]],"id,n",true]);
			funcid = func && func.length ? func[0][0] : undefined;
			funcn = func && func.length ? func[0][1] : undefined;
			var params = orm("gAnd",[[object.id, classes["–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞"]],"id,n",true]);
			params = params && params.length && params[0][1][0] == "{" ? JSON.parse(params[0][1]) : undefined;
			if (funcn && params){ window[funcn](params) } else { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ `"+object.n+"`!") };
		});
		return true;
	}
	return false;
}

function ifObjectIsLink(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isLink = (cid == classes["–°—Å—ã–ª–∫–∏"]);
	
	if (object.isLink && !object.isClass){
		object.but.addEventListener("click",  function(){
			var object = this.object;
			if (object.isStandart) return;

			var ind = object.n.indexOf("(");
			var uri = ind >=0 ? object.n.slice(ind+1,-1) : object.n;
			openWindow(uri);

		});
		return true;
	}
	return false;
}

////////
function ifObjectIsFile(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isFile = ((cid == classes["–§–∞–π–ª—ã"]) || (cid == classes["–§–æ—Ç–æ"]));

	if ( object.isFile && !object.isClass ){
		var txt = {value: object.n/*orm("gN",[object.id])*/};
		var img = new Image();
		var fn = txt.value;

		var arr = fn.split(".");
		var arrIm = ['jpg','bmp','png','gif','tif','JPG','BMP','PNG','GIF','TIF'];
		var ext = arr[arr.length-1];

		img.fn = fn;
		var cap = (fn) ? fn.split("/")[fn.split("/").length-1] : "";

		if (arr && arr.length && ~arrIm.indexOf(ext)) {
			img.src = domain+url2cp1251(fn);
			img.width = 32;
			cap = "";
		} else {
			var iconFile = getIconFile(fn);
			img.src = domain+iconFile;
			img.width = 16;
		}

		object.but.innerHTML = cap;
		img.style.cursor = "pointer";
		object.but.fn = fn;
		object.but.addEventListener("click",  function(){
			var object = this.object;
			if (object.isStandart) return;
			openWindow(domain+url2cp1251(this.fn));
		});
		object.but.appendChild(img);
		return true;
	} else if ( object.isFile && object.isClass ){
		if (cid == classes["–§–æ—Ç–æ"]) {
			object.but.addEventListener("click",  function(){
				var object = this.object;
				var pobject = object.pobject
				objectPhotoGallery(pobject);
			});
		}
	}

	return false;
}

function imagesPhotoGallery(images, caption){
	var frm = new Form(true);
	frm.setVisible(true);
	frm.getCaption().innerHTML = caption;
	var container = frm.getBody();

	var tb = container.appendChild(cDom("TABLE"));
	var tr = tb.appendChild(cDom("TR"));
	tb.style.width = "100%";
	var tdImg = tr.appendChild(cDom("TD"));
	tdImg.setAttribute("align", "center");
	tdImg.style.width = "100%";

	var imgContainer = cDom("DIV");
	tdImg.appendChild(imgContainer);

	imgContainer.style.height = getWindowHeight() - 150 + "px";

	var imgObject = new Image();
	if (images && images.length) {
		var imgInd = 0;
		
		imgObject.src = domain+images[imgInd];
		imgObject.style.cursor = "pointer";
		imgContainer.appendChild(imgObject);
		
		imgObject.style.maxWidth = "100%";
		imgObject.style.maxHeight = "100%";
		imgObject.title = "–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ";

		if (parseInt(getComputedStyle(imgObject).width) / parseInt(getComputedStyle(imgObject).height) > 1) {
			if (getComputedStyle(imgObject).width > getComputedStyle(imgContainer).width)
				imgObject.style.width = getComputedStyle(imgContainer).width
		} else {
			if (getComputedStyle(imgObject).height > getComputedStyle(imgContainer).height)
				imgObject.style.height = getComputedStyle(imgContainer).height
		}
		
		imgObject.onclick = function(){
			imgInd = (imgInd >= (images.length-1)) ? 0 : imgInd+1;
			this.src = domain+images[imgInd];
		}
	}
}

function objectPhotoGallery(pobject){
	var lid = pobject.id;
	var n = pobject.n;
	var cid = pobject.cid;
	var photoCid = classes["–§–æ—Ç–æ"];
	var images = orm("gT2id",[[cid,photoCid],[],[],false,["o"+photoCid+""],"and id_o"+cid+" ="+lid+" order by id_o"+cid+""]);
	imagesPhotoGallery(col2array(images), n)
}

function col2array(data){
	result = [];
	data.forEach(function(value) {
		result.push(value[0]);
	});
	return result;
}


////////
function ifObjectIsMap(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isMap = (cid == classes["–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–µ"] || cid == classes["–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ"]);
	
	if ( object.isMap && object.isClass ){
		setViewObject = object;
		var coord;
		var p = getPaint(object.pid)[0];
		if (p) {
			mapProps.mapFunctions.forEach(function(prop){ if (p.paintFunc == prop.drawFunc) coord = p[prop.getLatLngFunc](); })
			if (coord && coord.length) coord = coord[0];
			if (coord && coord.length) coord = coord[0];
		}
		
		if (coord && coord.lat) {
			map.setView([coord.lat, coord.lng], 18);
		}
		return true;
	} else if ( object.isMap && !object.isClass ){
		var p = getPaint(object.pid);
		if (p) {
			//object.layer = p[0];
			object.layers = p;
		}
		return true;
	}
	return false;
}

function ifObjectIsMapLinked(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isMapLinked = specialLinkedClasses.map.indexOf(cid)>=0;
	
	if ( object.isMapLinked && !object.isClass ) {//speed test without specialLinkedClasses with gAnd ~ 150ms vs 400ms in 8st and 400ms vs 800ms in 16st => 1/2-1/3
		object.but.onmouseover = function(){
			var object = this.object;
			var layers = getObjectMapLayer(object);
			if (layers && layers.length && layers[0].paintFunc != "Marker") {
				object.layers = layers;
				for (var i=0; i < layers.length; i++)
					layers[i].setStyle({color:"#ff0000", weight:2});
			}
		}
		
		object.but.onmouseout = function(){
			var object = this.object;
			var layers = getObjectMapLayer(object);
			if (layers && layers.length && layers[0].paintFunc != "Marker") {
				object.layers = layers;
				for (var i=0; i < layers.length; i++)
					layers[i].setStyle(layers[i].paintFuncParams);
			}
		}
		
		return true;
	} else if (object.isMapLinked && object.isClass && isMapLinkEnabled){
		drawClassMapLayer(object);
		return true;
	}
	return false;
}

function getObjectMapLayer(object){
	var layers;
	if (object.layers) {
		layers = object.layers;
	} else {
		layers = getPaint(object.id);
		//object.layer = layers[0];
		object.layers = layers;
	}
	return layers;
}

function drawClassMapLayer(object, isClassAllObjects){
	var params;
	var func;
	if (!isClassAllObjects) {
		var objects = gAndObject(object);
		
		if (objects && objects.length){
			var ids = [];
			for (var i=0; i < objects.length; i++){
				ids.push(objects[i][0]);
			}
		}
		params = {"id":object.pid, "cid":object.id, "ids":ids};
		func = drawObjectMapLayer;
	} else {
		params = {"cid":object.id};
		func = drawClassAllObjectMapLayer;
	}
	
	if (params) {
		func(params, function(layer){
			var exist = false;
			for (var i=0; i < storageMapLayers.length; i++){
				if (storageMapLayers[i] && storageMapLayers[i].cid == layer.cid) {
					var _layer = storageMapLayers[i];
					storageMapLayers[i] = layer;
					_layer.clearLayers();
					_layer.remove();
					exist = true;
					break;
				}
			}
			if (!exist) {
				storageMapLayers.push(layer);
				exist = true;
			}
			if (exist) {
				layer.addTo(map);
				refreshMapLinkForm(frmPaintLayers);
				ifObjectIsMap(setViewObject);
			}
		});
	}
}

function drawClassAllObjectMapLayer(object, callback){
	var cid = +object.cid;
	var mapLinkCids = [classes["–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ"],classes["–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–µ"]];
	var paintFuncCid = classes["–§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"];
	var paintFuncParamsCid = classes["–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"];
	var coordsCid = classes["–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ"];
	var oldcids = [ +classes["–ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏"],+classes["–ó–¥–∞–Ω–∏—è –∏ —Å–æ–æ—Ä—É–∂–µ–Ω–∏—è"],+classes["–≠–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"],+classes["–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"],+classes["–¢–µ–ø–ª–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"],+classes["–í–æ–¥–æ–æ—Ç–≤–µ–¥–µ–Ω–∏–µ"] ];
	var oldcidsind = oldcids.indexOf(cid);
	mapLinkCid = (oldcidsind >= 0) ? mapLinkCids[0] : mapLinkCids[1];
	
	var _params1 = {"cid":cid, "oldcidsind" : oldcidsind};
	orma("gT2id",[	[cid, mapLinkCid, coordsCid, paintFuncCid,paintFuncParamsCid], [[2,1],[3,1], [4,1]],[],false,
		["o"+coordsCid+"","id_o"+mapLinkCid+"","id_o"+cid+"","o"+paintFuncCid+"","o"+paintFuncParamsCid+""],
		" and id_o"+coordsCid+" is not null order by id_o"+mapLinkCid+", id_o"+coordsCid ], function(result)
		{
			var coords = result.data;
			//console.log(coords[coords.length-1])
			var params1 = result.params;
			if (!coords || !coords.length) return;
			var latlngs = [];
			var polyId = coords[0][1];
			var objId = coords[0][2];
			var layer = L.layerGroup();

			var paintFunc = coords[0][3] ? coords[0][3] : "";
			var paintFuncParams = paintFunc && coords[0][4] ? JSON.parse(coords[0][4]) : "";

			if (paintFunc == "Marker") paintFuncParams = paintFuncParams ? {"icon":L.icon(paintFuncParams)} : 
				(params1.cid == classes["–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"] ? {"icon":L.icon({"iconUrl":"images/arendator.png"})} : null) ;
			if (paintFunc == "Circle") {paintFuncParams = {"radius":1, "color":"#ffff00"}; }
			
			var oldcidsind = params1.oldcidsind;
			if (!paintFunc) {//–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ
				paintFunc = (oldcidsind>=0 && oldcidsind<2) ? "Polygon" : "Polyline";
				paintFuncParams = {"weight":1, "color": paintFunc == "Polygon" ? "#00ff00" : 
					oldcidsind == 2 ? "#ffff00" : oldcidsind == 3 ? "#0000ff" :	oldcidsind == 4 ? "#ff9900" : oldcidsind == 5 ? "#aa6600" : "#ffff00"
				};
			}

			function _endPaint(latlngs){
				if (latlngs && latlngs.length) {
					if (latlngs.length == 1) {
						if (paintFunc == "Polyline" || paintFunc == "Polygon") return;
						latlngs = latlngs[0];
					}
					var p = L[paintFunc.toLowerCase()](latlngs, paintFuncParams).addTo(layer);
					p.cid = params1.cid;
					layer.cid = params1.cid;
					p.paintFunc = paintFunc;
					p.paintFuncParams = paintFuncParams;
					
					p.oid = polyId;
					p.cid = cid;
					p.lid = objId;
					p.pid = objId;
					p.on('mouseover', mapLayerOnMouseOver);
					p.on('mouseout', mapLayerOnMouseOut);
					p.on('click', mapLayerOnClick);
					p.on('contextmenu', mapLayerOnContextMenu);
				}
			}
			
			for (var i=0; i < coords.length; i++){
				var latlng = coords[i][0];
				
				if (polyId != coords[i][1] && latlngs) {
					_endPaint(latlngs);
					latlngs = [];
				}
				if (latlng && latlng[0] == "{" || latlng[0] == "[") {
					latlngs.push(JSON.parse(latlng));
				} else {
					latlngs.push(latlng.split(" "));
				}
				polyId = coords[i][1];
				objId = coords[i][2];
				if (i == coords.length-1){
					_endPaint(latlngs);
					callback(layer);
				}

			}
		}, _params1);
}

function drawObjectMapLayer(object, callback){
	var cid = +object.cid;
	var id = +object.id;
	var ids = object.ids;///
	var mapLinkCids = [classes["–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ"],classes["–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–µ"]];
	var paintFuncCid = classes["–§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"];
	var paintFuncParamsCid = classes["–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"];
	var color = object.color;// || getRandomColor();
	var oldcids = [ +classes["–ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏"],+classes["–ó–¥–∞–Ω–∏—è –∏ —Å–æ–æ—Ä—É–∂–µ–Ω–∏—è"],+classes["–≠–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"],+classes["–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"],+classes["–¢–µ–ø–ª–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"],+classes["–í–æ–¥–æ–æ—Ç–≤–µ–¥–µ–Ω–∏–µ"] ];
	var oldcidsind = oldcids.indexOf(cid);
	mapLinkCid = (oldcidsind >= 0) ? mapLinkCids[0] : mapLinkCids[1];
	
	var _params1 = {"cid":cid, "id":id, "ids":ids, "color":color, "oldcidsind" : oldcidsind};
	orma("gT2id",[	[cid, mapLinkCid, paintFuncCid,paintFuncParamsCid], [[2,1],[3,1]],[],false,
		["id_o"+mapLinkCid+"","o"+paintFuncCid+"","o"+paintFuncParamsCid+"","id_o"+cid+""],
		(ids && ids.length ? "and id_o"+cid+" in ("+ids.join(",")+")" : (id ? "and id_o"+cid+" = "+id : "") )+
		" and id_o"+mapLinkCid+" is not null order by id_o"+mapLinkCid+"" ], function(result)
		{
//console.time("id"+object.id);
			var maplinks = result.data;
			var params1 = result.params;
			var layer = L.layerGroup();

			var res = 0;
			for (var i=0; i < maplinks.length; i++){
				var mapLink = maplinks[i];
				var mapLinkId = mapLink[0];
				var paintFunc = mapLink[1];
				var paintFuncParams = JSON.parse(mapLink[2]);
				var oid = params1.ids && params1.ids.length ? +mapLink[3] : params1.id;

				if (paintFunc == "Marker") paintFuncParams = paintFuncParams ? {"icon":L.icon(paintFuncParams)} : 
					(params1.cid == classes["–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"] ? {"icon":L.icon({"iconUrl":"images/arendator.png"})} : null) ;
				if (paintFunc == "Circle") {paintFuncParams = {"radius":1, "color":"#ffff00"}; }

				/*var coords = */
				var _params2 = {"layer":layer, "mapLinkId": mapLinkId, "oid": oid, "cid":params1.cid, "id":params1.id, "paintFunc":paintFunc, "paintFuncParams":paintFuncParams,
					"color":params1.color, "onmouseover":onmouseover, "onmouseout":onmouseout, "onclick":onclick, "oncontextmenu":oncontextmenu,
					oldcidsind:params1.oldcidsind};

				orma("gAnd",[[mapLinkId, classes["–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ"]],"n",true], function(result){
					var coords = result.data;
					var params2 = result.params;
					res++;
			
					var oldcidsind = params2.oldcidsind;
					if (!params2.paintFunc) {//–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ
						params2.paintFunc = (oldcidsind>=0 && oldcidsind<2) ? "Polygon" : "Polyline";
						params2.paintFuncParams = {"weight":1, "color": params2.paintFunc == "Polygon" ? "#00ff00" : 
							oldcidsind == 2 ? "#ffff00" : oldcidsind == 3 ? "#0000ff" :	oldcidsind == 4 ? "#ff9900" : oldcidsind == 5 ? "#aa6600" : "#ffff00"
						};
					}

					var latlngs = [];
					for (var latLngInd=0; latLngInd < coords.length; latLngInd++){
						var latlng = coords[latLngInd][0];
						if (latlng && latlng[0] == "{" || latlng[0] == "[") {
							latlngs.push(JSON.parse(latlng));
						} else {
							latlngs.push(latlng.split(" "));
						}
					}
					if (latlngs && latlngs.length) {
						if (latlngs.length == 1) {
							if (params2.paintFunc == "Polyline" || params2.paintFunc == "Polygon") return;
							latlngs = latlngs[0];
						}

						var p = L[params2.paintFunc.toLowerCase()](latlngs, params2.paintFuncParams).addTo(params2.layer);
						p.oid = params2.mapLinkId;
						p.lid = params2.oid;
						p.cid = params2.cid;
						p.pid = params2.id;
						p.paintFunc = params2.paintFunc;
						p.paintFuncParams = params2.paintFuncParams;
						p.on('mouseover', mapLayerOnMouseOver);
						p.on('mouseout', mapLayerOnMouseOut);
						p.on('click', mapLayerOnClick);
						p.on('contextmenu', mapLayerOnContextMenu);
						callbacklayerinner(res);
					}
				}, _params2);
				
			}
			function callbacklayerinner(res){
				if (res == maplinks.length){
					layer.cid = params1.cid;
					callback(layer);
				}
			}
//console.timeEnd("id"+object.id);
		}, _params1);
}

function mapLayerOnMouseOver(e) {
	if (this.paintFunc != "Marker") 
		this.setStyle({color:"#ff0000", weight:2}); 
	
	var cell = gDom("but.object.id"+this.lid+"pid"+this.pid);
	if (cell) cell.style.color = "#ff9999";
}
function mapLayerOnMouseOut(e) { 
	if (this.paintFunc != "Marker")
		this.setStyle(this.paintFuncParams); 
		
	var cell = gDom("but.object.id"+this.lid+"pid"+this.pid);
	if (cell) cell.style.color = "#fff";
}
function mapLayerOnClick(){
	console.log(this);
	if (isPaintMode && this.paintFunc != "Marker") {
		if (currentEditing) {
			currentEditing.disableEdit();
		}
		currentEditing = this;
		currentEditing.enableEdit();
	} else {
		if (confirm("–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—ä–µ–∫—Ç—É, —Å–≤—è–∑–∞–Ω–Ω–æ–º—É —Å –ª–∏–Ω–∏–µ–π?")) loadNewForm(this.lid, this.cid);
	}
}
function mapLayerOnContextMenu(e) { 
	if (this.paintFunc != "Marker") {
		new ContextMenu([
			new ContextMenuItem("–£–¥–∞–ª–∏—Ç—å", function(){ 
				currentEditing = this.ctx;
				if (getPolicy(currentEditing.oid)){
					if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é –∫–ª–∞—Å—Å–∞ "+classes3(this.ctx.cid)+" ?")){
						var res = orm("nL",[currentEditing.oid, currentEditing.lid]);
						if (res) {
							currentEditing.disableEdit();
							currentEditing.remove();
							currentEditing = null;//this.ctx;
						}
					}
				} else { alert("–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ª–∏–Ω–∏–∏ –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞!"); }
				currentEditing = null;
			}, this), 
			], e.containerPoint.x, e.containerPoint.y);
		return false;
	}
}

function clearStorageMapLayers(){
	storageMapLayers.forEach(function(layer){
		if (layer) {
			layer.clearLayers();
			layer.remove();
		}
	});
	storageMapLayers = [];
}

function initializeMapLinkForm(map, frm){
	var cnt = frm.getBody();
	cnt.innerHTML = "";
	var tb = cDom("TABLE");
	cnt.appendChild(tb);
	var arr = orm("gAnd",[[classes["–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ"]],"id,n",false,"",true,true]).concat(
			orm("gAnd",[[classes["–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–µ"]],"id,n",false,"",true,true]));
	var ret = [];
	var tr = cDom("TR",null,tb);
	var td = cDom("TD",null,tr);
	frm.setWidth("300px");
	frm.chcks = [];
	
	for (var i=0; i < arr.length; i++){
		var id = arr[i][0];
		if (id == 1) continue;
		var n = arr[i][1];
		var tr = cDom("TR",null,tb);
		var td = cDom("TD",null,tr);
		
		var ch = cInp("CHECKBOX");
		var lab = cDom("LABEL");
		lab.innerHTML = n;
		td.appendChild(ch);
		td.appendChild(lab);
		lab.cursor = "pointer";
		lab.ch = ch;
		
		ch.map = map;
		ch.cid = id;
		ch.n = n;
		ch.layer = L.layerGroup();
		ch.onchange = function(){
			if (this.checked) {
				drawClassMapLayer({id:this.cid, isClass:true}, true)
			} else {
				for (var layerind=0; layerind < storageMapLayers.length; layerind++){
					var layer = storageMapLayers[layerind];
					if (layer && +layer.cid == +this.cid) {
						layer.clearLayers();
						layer.remove();
					}
				}
			
			}
		};
		//ch.disabled = true;
		frm.chcks.push(ch);
	}
	frm.setLeft((getWindowWidth()-parseInt(getComputedStyle(frm.getDom()).width)-1)+"px");

}

function refreshMapLinkForm(frm){
	for (var i=0; i < frm.chcks.length; i++){
		var ch = frm.chcks[i];
		ch.checked = false;
		for (var layerind=0; layerind < storageMapLayers.length; layerind++){
			var layer = storageMapLayers[layerind];
			if (layer && +layer.cid == +ch.cid) ch.checked = true;
		}
	}
}

function endPaint(layer){
	var object = { cid:storageObjects.slice(-1)[0].pcid, oid:storageObjects.slice(-1)[0].pid, isMap:storageObjects.slice(-1)[0].isMap };
	var cid = layer.cid ? layer.cid : object.cid;
	var oid = layer.lid ? layer.lid : object.oid;
	var isPaint = orm("gL",[cid, classes["–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–µ"]]) || orm("gL",[cid, classes["–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ"]]);
	isPaintMode = false;
	
	if (!isPaint || !getPolicy(oid)) {
		alert(!isPaint ? "–≠–ª–µ–º–µ–Ω—Ç '"+orm("gN",[cid])+": "+orm("gN",[oid])+"' –Ω–µ–ª—å–∑—è –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –∫–∞—Ä—Ç–µ!" : "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–∞—Ä—Ç–µ!");
		layer.remove();
		return;
	}
	
	if (!currentEditingType){
		var paintfunc = layer.paintFunc;
		if (!paintfunc) {
			paintfunc = orm("gAnd",[[layer.oid, classes["–§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"]],null,true])[0];
			paintfunc = (paintfunc && paintfunc.length) ? paintfunc[1] : "";
		}
		currentEditingType = paintfunc;
	}

	mapProps.mapFunctions.forEach(function(prop){
		if (currentEditingType == prop.drawFunc){
			if (!object.isMap) {
				alert("–î–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–∞—Ä—Ç–µ!");
				layer.remove();
				return;
			}
			var func = prop.drawFunc;
			var params = cid == classes["–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"] ? '{"iconUrl":"images/arendator.png"}' : "";
			var latlngs = layer[prop.getLatLngFunc]();
			var coords = JSON.stringify(latlngs,["lat","lng"]);
			if (confirm((layer.oid ? "–ò–∑–º–µ–Ω–∏—Ç—å" : "–ü—Ä–∏–≤—è–∑–∞—Ç—å")+" –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∫ –æ–±—ä–µ–∫—Ç—É '"+orm("gN",[cid])+": "+orm("gN",[oid])+"'")) {
				var _oid = orm("createPolygonObject",[oid, func, params, JSON.parse(coords)]);
				console.log("create drawing:",_oid);
				
				if (layer.oid && layer.lid) {
					orm("nO",[layer.oid]);
					console.log("delete old drawing:", layer.oid);
				} else {
					layer.remove();
				}
			} else {
				layer.remove();
			}
			currentEditingType = "";
		}
	})
}

function getPaint(oid){
	var findLayers = [];
	map.eachLayer(function(layer){
		var lid = layer.lid || layer.oid;
		if (lid && lid == oid) {
			findLayers.push(layer);
			//return;
		}
	});
	return findLayers;
}

//////////
window.onkeydown = function(e){
	if (e.key == "F4") { objectsTable(); }
	if (e.key == "F7" && currentUser.uid == 1577) {
		var params = prompt(":>",[currentUser.oid, currentUser.cid].join(","));
		var _oid = params.split(",")[0];
		var _cid = params.split(",")[1];
		loadNewForm(+_oid, +_cid);
	}
	if (e.ctrlKey && e.key == "Home") {
		userSetup()
	}
	if (e.ctrlKey && e.key == "F1") {
		globalstopFunction = true;
	}
	//if (e.key == "Insert") { if (e.target.nodeName != "INPUT") {objectAdd(); return false}}
	//if (e.key == "Delete") { if (e.target.nodeName != "INPUT") {objectDel(null, true); return false;} }
	//if (e.key == "F2") { if (e.target.nodeName != "INPUT") {objectUpd(); return false;} }
}

/////////////JS CLASSES
function ContextMenuItem(caption, onclickfunc, ctx){
	var item = cDom("BUTTON");
	item.caption = caption;
	item.onclickfunc = onclickfunc;
	item.innerHTML = caption;
	item.onclick = onclickfunc;
	item.ctx = ctx;
	item.style.width = "100%";
	item.style.textAlign = "left";
	return item;
}

function ContextMenu(items, x, y){
	var menu;
	menu = document.body.appendChild(cDom("DIV"));
	menu.style.backgroundColor = "rgba(0,0,0,0.5)";
	menu.style.position = "absolute";
	menu.style.zIndex = 300000;
	menu.style.left = x-3+"px";
	menu.style.top = y-3+"px";
	menu.id = "menu";
	menu.hidden = false;
	menu.onmouseleave = function(){ this.remove() }
	items = items || [];
	
	var tb = menu.appendChild(cDom("TABLE"));
	tb.style.width = "100%";
	for (var i=0; i < items.length; i++){
		var item = items[i];
		if (!item) continue;
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		td.appendChild(item);
	};
	
	return menu;
	
}

function ObjectSelectForm(object, params){
	var caption = params.caption;
	var defval = params.defval;
	var callback = params.callback;

	var frm = new Form(true);
	frm.setVisible(true);
	var cnt = frm.getBody();
	var cap = caption ? "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" : "–í—ã–±—Ä–∞—Ç—å";
	frm.getCaption().innerHTML = caption ? caption : cap+": "+object.n;
	var tb = cnt.appendChild(cDom("table"));
	tb.style.width = "100%"
	tb.style.textAlign = "center";

	var tr = tb.appendChild(cDom("tr"));
	var tdList = tr.appendChild(cDom("td"));
	
	function refresh(object, td, notFilter, but, defval){
		td.innerHTML = "";
		var objects = gAndObject(object.isClass && !object.isGroup ? object : {id:1, cid:1}, notFilter);
		var objectlist = ObjectListDom(objects);
		var list = objectlist.list;
		list.style.width = "300px";
		var datalist = objectlist.datalist;
		td.appendChild(list);
		td.appendChild(datalist);
		list.value = defval;
		list.focus();
		list.onkeydown = function(e){
			if (e.keyCode == 13) {
				but.onclick();
			}
		}
		but.lst = list;
	}
	
	var tr = tb.appendChild(cDom("tr"));
	var td = tr.appendChild(cDom("td"));
	var ch = td.appendChild(cInp("checkbox"));
	ch.checked = true;

	var lab = td.appendChild(cDom("label","–§–∏–ª—å—Ç—Ä: `"+object.n+"` : `"+orm("gN",[object.pid])+"`"));
	
	var tr = tb.appendChild(cDom("tr"));
	var td = tr.appendChild(cDom("td"));
	tr.style.height = "50px";
	var but = td.appendChild(cDom("button", cap));
	but.frm = frm;
	but.object = object;
	but.onclick = function(){
		callback(this.lst.value, this.object);
		this.frm.setVisible(false);
	}
	ch.object = object;
	ch.tdList = tdList;
	ch.but = but;
	ch.defval = defval;
	ch.onchange = function(){
		refresh(this.object, this.tdList, !this.checked, this.but, "")
	}
	if (!object.isClass || object.isGroup) {ch.remove(); lab.remove(); };
	
	refresh(object, tdList, false, but, defval);
	cnt.frm = frm;
	cnt.onkeydown = function(e){
		if (e.keyCode == 27) this.frm.setVisible(false);
	}
}

function ObjectListDom(objects) {
	var tmstmp = Date.now();
	var list = cDom("input");
	list.setAttribute("list", "datalist"+tmstmp);
	var datalist = cDom("datalist");
	datalist.id = "datalist"+tmstmp;
	for (var i=0; i < objects.length; i++){
		var object = objects[i];
		var opt = cDom("option");
		opt.value = object[1];
		opt.id = "opt"+object[0];
		datalist.appendChild(opt);
	}
	return {"list":list, "datalist":datalist};

}

function ClassesObject(cObjects){
	var that = this;
	this.classes = [];
	
	this.addClass = function(cObject){ that.classes.push(cObject); }
	this.addClasses = function(cObjects){
		for (var i=0; i < cObjects.length; i++){
			that.addClass(cObjects[i]);
		}
	}
	
	this.getClass = function(cid){
		var classes = that.classes;
		for (var i=0; i < classes.length; i++){
			var cObject = classes[i];
			if (cObject.cid == +cid) {
				return cObject;
			}
		}
	}
	if (cObjects && cObjects.length) {this.addClasses(cObjects)};
	
}

function ClassObject(cid){
	var that = this;
	this.cid = +cid;
	this.isClassGroup = classesGroup.indexOf(this.cid) >= 0;
	this.parent = [];
	this.child = [];
	
	this.getChild = function(){	return new ClassesObject(that.child); }
	this.setChild = function(cObject){	that.child.push(cObject); }

	this.getParent = function(){ return new ClassesObject(that.parent); }
	this.setParent = function(cObject){ that.parent.push(cObject);	}
	
	this.childExist = function(chain){
	}
}

function ClassesChains(cObject){
	var that = this;
	this.chains = [];
	this.cObject = cObject;

	this.go = function (cObject, _chain){
		var chains = that.chains
		cObject = cObject || classesObjects.getClass(1383);
		var child = cObject.getChild().classes;
		var chain = _chain ? _chain.slice() : [];
		chain = chain || [];
		
		if (chain.indexOf(cObject.cid) >=0) {
			chains.push(chain.slice());
			return;
		}

		if (chain.length) {chain.push(cObject.cid)} else { chain = [cObject.cid] }
		
		if (!child.length) {
			chains.push(chain.slice());
			return;
		}
		
		for (var i=0; i < child.length; i++){
			that.go(child[i], chain);
		}
	}
	this.go(cObject);
	
	this.find = function(cid, maxlength){
		maxlength = maxlength || 20;
		var chains = that.chains;
		var _chains = [];
		for (var i=0; i < chains.length; i++){
			if (chains[i].indexOf(cid) >= 0 && chains[i].length <= maxlength) _chains.push(chains[i]);
		}
		_chains.sort( function (a, b) { if (a.length > b.length) return 1; if (a.length < b.length) return -1; } );
		return _chains;
	}
	
	this.getStorageChainCond = function(){
		var cond = [];
		var cid = 0;
		var n = "";
		for (var i=0; i < storageObjects.length; i++){
			var object = storageObjects[i];
			if (cid) {
				if (!object.isClass) {
					n = object.n;
					cond.push("'"+n+"'");
				} else {
					cond.splice(-1);
				}
				cid = 0;
			}
			if (object.isClass && !object.isGroup && i < storageObjects.length-1) {
				cid = object.id;
				cond.push(" and id_o"+cid+" is not null ");
				cond.push(" and o"+cid+" = ");
			}
		}
		return cond.join("");
	}
	
	this.gAndCounter = Object.create(null);
	this.gAnd = function(cid, asynccallback, asynccallbackparams){
		var find = that.find(cid, 10);//length of chain links cid=1423 (~5s)
		var cond = this.getStorageChainCond();
		console.log("gAnd filter:", cond);
		this.gAndCounter.value = 0;
		var _find = [];
		for (var i=0; i < find.length; i++){
			var contin = false;
			var cids = find[i];
			storageObjects.forEach(function(o){ if (o.isClass && cids.indexOf(o.id)<0 ) contin = true; });
			if (contin) continue;
			_find.push(find[i]);
		}
		var chainscount = _find.length;
		
		for (var i=0; i < _find.length; i++){
			var cids = _find[i];
			var links = [];
			var _cids = [];
			var ind = -1;
			for (var j=0; j < cids.length; j++){
				var _cid = cids[j];
				if (classesGroup.indexOf(_cid)<0) {
					ind++;
					_cids.push(_cid);
					if (ind>0) links.push([ind, ind-1]);
				}
			}
			var gAnd = orma("gT2id", [_cids, links, [],false,["o"+cid+""], " and id_o"+cid+" is not null "+cond], function(result){
				var _asynccallback = result.params.func;
				var data = result.data;
				result.params.counter.value++;
				var islast = result.params.counter.value == result.params.chainscount;
				if ((data && data.length) || islast) _asynccallback(data, islast, result.params.funcparams);
				if (result.params.func && result.params.func.error) console.log("gAnd ajax error:",result.params.func.error);
			}, {func:asynccallback, funcparams:asynccallbackparams, chainscount:chainscount, counter:that.gAndCounter});
			
		}
		console.log("gAnd: run");
		return true;
	}
//classesChains.chains.reduce(function(max, e){return max = e.length > max.length ? e : max},[]) //–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞
}

/////////////////ifObjectScript SCRIPTS//////////////////
function reportZatrat(params){///exec from ifObjectScript (as eval)
	var oid = params.oid || 0;
	var year = params.year || 2018;
	
	function getZatratDogInMonth(oid, year, month, dog){
		var data = orm("gT2",[ 
		[ "–ó–∞—Ç—Ä–∞—Ç—ã","–°—É–º–º–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç","–°—É–º–º–∞ –ø–µ—Ä–µ–≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç","–ì–æ–¥ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç","–ú–µ—Å—è—Ü –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç","–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞","–û–±—ä–µ–∫—Ç—ã" ],
			[],[],false,[],
			"and `–ì–æ–¥ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç`="+year+" and `–ú–µ—Å—è—Ü –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç`="+month+" and `–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞`= '"+dog+"' and `id_–û–±—ä–µ–∫—Ç—ã`="+oid
			]);
		data = data && data.length ? data[0] : [];
		var sumz = data[3] ? parseFloat(data[3]) || 0 : 0;
		var sump = data[5] ? parseFloat(data[5]) || 0 : 0;
		var sums = sumz-sump;
		
		return [sumz, sump, sums];
	}

	function getDogsInYear(oid, year){
		var data = orm("gT2",[ 
			[ "–ó–∞—Ç—Ä–∞—Ç—ã","–ì–æ–¥ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç","–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞","–û–±—ä–µ–∫—Ç—ã" ],
			[],[],false,[],
			"and `–ì–æ–¥ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç`="+year+" and `id_–û–±—ä–µ–∫—Ç—ã`="+oid
			]);
		var arr = [];
		for (var i=0; i < data.length; i++){
			var dog = data[i][5];
			if (arr.indexOf(dog)<0) arr.push(dog);
		}
			
		return arr;
	}

	function getArendatorSum(oid){
		var data = orm("gT2",[ 
			[ "–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã","–î–æ–≥–æ–≤–æ—Ä—ã –∞—Ä–µ–Ω–¥—ã","–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã","–û–±—ä–µ–∫—Ç—ã" ],
			[[2,1]],[],false,[],
			"and `id_–û–±—ä–µ–∫—Ç—ã`="+oid
			]);
		var sum = 0;
		for (var i=0; i < data.length; i++){
			var pay = +parseFloat(data[i][5]);
			sum += pay;
		}
		return sum.toFixed(2);
	}
	
	var frm = new Form();
	frmPaintLayers.setCaption(cDom("LABEL","–û—Ç—á–µ—Ç –ø–æ –∑–∞—Ç—Ä–∞—Ç–∞–º –∑–∞ "+year+":")).style.color = "#ffdd00";
	frm.setVisible(true);
	var cnt = frm.getBody();
	cnt.innerHTML = "";
	var arrDogs = getDogsInYear(oid, year)
	var months = ["—è–Ω–≤","—Ñ–µ–≤","–º–∞—Ä—Ç","–∞–ø—Ä","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥","—Å–µ–Ω—Ç","–æ–∫—Ç","–Ω–æ—è–±","–¥–µ–∫"];
	var arendatorMoneyMonth = getArendatorSum(oid);
	
	var tb = cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	tb.border = 1;
	
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "–£—Å–ª—É–≥–∞ / –º–µ—Å—è—Ü";

	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "center";
		td.innerHTML = months[month-1];
	}
	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "center";
	td.innerHTML = "<b>–ò—Ç–æ–≥–æ</b>";

	var monthSum = [[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0]];
	for (var i=0; i < arrDogs.length; i++){
		var dog = arrDogs[i];
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		td.innerHTML = dog;
		var dogSum = [0,0,0];
		
		for (var month=1; month <= 12; month++){
			var td = tr.appendChild(cDom("TD"));
			td.style.textAlign = "right";
			var arrSum = getZatratDogInMonth(oid, year, month, dog);
			var zat = +arrSum[0].toFixed(2);
			var per = +arrSum[1].toFixed(2);
			var sum = +arrSum[2].toFixed(2);
			td.innerHTML = "<label style='color:#ff0000'>"+(""+zat).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff'>"+(""+per).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00'>"+(""+sum).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
			dogSum[0] += zat;
			dogSum[1] += per;
			dogSum[2] += sum;
			monthSum[0][month-1] += zat;
			monthSum[1][month-1] += per;
			monthSum[2][month-1] += sum;
		}
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		td.innerHTML = "<label style='color:#ff0000; font-weight:bold'>"+(dogSum[0].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff; font-weight:bold'>"+(dogSum[1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00; font-weight:bold'>"+(dogSum[2].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
		monthSum[0][12] += +dogSum[0].toFixed(2);
		monthSum[1][12] += +dogSum[1].toFixed(2);
		monthSum[2][12] += +dogSum[2].toFixed(2);
		
	}
/////
	var tr = tb.appendChild(cDom("TR"));
	tr.style.height = "10px";
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥";

	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		td.innerHTML = "<label style='color:#ff0000; font-weight:bold'>"+(monthSum[0][month-1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff; font-weight:bold'>"+(monthSum[1][month-1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00; font-weight:bold'>"+(monthSum[2][month-1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
	}

	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "right";
	td.innerHTML = "<label style='color:#ff0000; font-weight:bold; font-size:14px'>"+(monthSum[0][12].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff; font-weight:bold'>"+(monthSum[1][12].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00; font-weight:bold'>"+(monthSum[2][12].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
/////
	var tr = tb.appendChild(cDom("TR"));
	tr.style.height = "10px";
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "–î–æ—Ö–æ–¥ –æ—Ç –∞—Ä–µ–Ω–¥—ã";
	
	var arendatorMoneyMonthSum = 0;
	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		td.innerHTML = "<label style='color:#00ff00; font-weight:bold'>"+(""+arendatorMoneyMonth).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
		arendatorMoneyMonthSum += +arendatorMoneyMonth;
	}

	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "right";
	td.innerHTML = "<label style='color:#00ff00; font-weight:bold; font-size:14px'>"+(arendatorMoneyMonthSum.toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
/////	
	var tr = tb.appendChild(cDom("TR"));
	tr.style.height = "10px";
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "–ò—Ç–æ–≥–æ –≠–∫–∫.—ç—Ñ—Ñ";
	
	var ekkeffSum = 0;
	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		ekkeff = (+arendatorMoneyMonth - +monthSum[2][month-1]).toFixed(2);
		ekkeffSum += +ekkeff;
		td.innerHTML = "<label style='color:#fff; font-weight:bold'>"+(""+ekkeff).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
	}

	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "right";
	td.innerHTML = "<label style='color:#fff; font-weight:bold; font-size:16px'>"+(""+ekkeffSum).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
/////	
	return true;
}

/////////////TEST FUNCTIONS
function runonclasses(frm, cObject, pcObject){
	var child = cObject ? cObject.getChild().classes : getAllClassesGraph()[2];
	if (frm) frm.getBody().innerHTML = "";
	frm = frm || new Form();
	frm.setVisible(true);
	var tb = cDom("table","",frm.getBody());
	
	if (cObject && cObject.getParent().classes) {
		var but = cDom("button", "<<<<<<<<<<<<", cDom("td","",cDom("tr","",tb)));
		but.parent = parent;
		but.pcObject = pcObject;
		but.cObject = cObject;
		but.frm = frm;
		but.onclick = function(){
			if (this.parent) runonclasses(this.frm, this.pcObject);
		}
	}
	
	for (var i=0; i < child.length; i++){
		var _cObject = child[i];
		var but = cDom("button", classes3(_cObject.cid), cDom("td","",cDom("tr","",tb)));
		but.onclick = onclick;
		but.cObject = _cObject;
		but.pcObject = cObject;
		but.frm = frm;
	}
	
	function onclick(){
		runonclasses(this.frm, this.cObject, this.pcObject);
	}
}

function getAllClassesGraph(){
	var arr1 = [];
	var arr2 = [];
	var arr3 = [];
	for (var i=0; i < classesObjects.classes.length; i++){
		var cObject = classesObjects.classes[i];
		if (!cObject.child.length) arr1.push(cObject);//without child
		if (!cObject.parent.length) arr2.push(cObject);//without parent - not actual
		if (cObject.child.length && cObject.parent.length) arr3.push(cObject);
	}
	return [arr1, arr2, arr3];
}
////////////////////////


</script>
	</body>
</html>